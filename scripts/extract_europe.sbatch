#!/bin/bash
#SBATCH --job-name=extract_europe_images
#SBATCH --partition=PGR-Standard
#SBATCH --gres=gpu:1           # Request 1 GPU (if needed for later processing)
#SBATCH --mem=64G              # Allocate 64GB memory for faster file I/O
#SBATCH --time=06:00:00        # Set max runtime (adjust as needed)
#SBATCH --output=logs/extract_europe_images.out
#SBATCH --error=logs/extract_europe_images.err
#SBATCH --cpus-per-task=16     # Use 16 CPU cores for parallel file operations

echo "ğŸš€ Starting SLURM job on $(hostname)"
echo "ğŸ”§ Activating Python environment..."
source ~/venvs/geogettr/bin/activate

# **Set Paths**
SCRATCH_DIR="/disk/scratch/$USER/my_datasets/osv5m"
HOME_DIR="$HOME/Work/geogettr/my_datasets/osv5m"
TRAIN_DIR="$SCRATCH_DIR/images/train"             # Unzipped dataset in scratch
OUTPUT_SCRATCH="$SCRATCH_DIR/images/train_europe" # Extracted European images stored in scratch first
OUTPUT_HOME="$HOME_DIR/images/train_europe"       # After extraction, move to home
IMAGE_IDS_FILE="$SCRATCH_DIR/europe_image_ids.txt" # European image IDs in scratch

# **ğŸ”¥ Step 1: Reset Scratch Storage**
echo "ğŸ—‘ï¸ Deleting existing dataset in scratch (if any)..."
rm -rf "$SCRATCH_DIR"

# **ğŸ”¥ Step 2: Move dataset and europe_image_ids.txt to scratch**
mkdir -p "$SCRATCH_DIR/images"
echo "ğŸ“‚ Copying dataset (98 ZIPs) to scratch..."
rsync -a --progress "$HOME_DIR/images/train/" "$TRAIN_DIR/"

echo "ğŸ“„ Copying europe_image_ids.txt to scratch..."
rsync -a --progress "$HOME_DIR/europe_image_ids.txt" "$SCRATCH_DIR/"

# **ğŸ”¥ Step 3: Delete previous train_europe and create fresh one**
echo "ğŸ—‘ï¸ Removing previous extracted images in scratch..."
rm -rf "$OUTPUT_SCRATCH"
mkdir -p "$OUTPUT_SCRATCH"

# **ğŸ”¥ Step 4: Run extraction script (in scratch)**
echo "ğŸ“‚ Extracting European images from dataset..."
python ~/Work/geogettr/extract_european_images.py

# **ğŸ”¥ Step 5: Move extracted images back to home (parallel transfer)**
echo "ğŸš› Moving extracted images to home directory..."
rsync -a --info=progress2 "$OUTPUT_SCRATCH/" "$OUTPUT_HOME/"

echo "ğŸ‰ SLURM job finished extracting European images!"
